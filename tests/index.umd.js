/**
 * MIT License
 * 
 * Copyright (c) 2022 大漠穷秋
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";var I="undefined"!=typeof Float32Array?Float32Array:Array,k=Math.PI/180;function f(t,e){var s=e[0],i=e[1],n=e[2],r=e[3],o=e[4],e=e[5],a=s*r-i*n;return a?(t[0]=r*(a=1/a),t[1]=-i*a,t[2]=-n*a,t[3]=s*a,t[4]=(n*e-r*o)*a,t[5]=(i*o-s*e)*a,t):null}function H(t,e,s){var i=e[0],n=e[1],r=e[2],o=e[3],a=e[4],e=e[5],h=s[0],l=s[1],c=s[2],d=s[3],u=s[4],s=s[5];return t[0]=i*h+r*l,t[1]=n*h+o*l,t[2]=i*c+r*d,t[3]=n*c+o*d,t[4]=i*u+r*s+a,t[5]=n*u+o*s+e,t}function v(t,e,s){var i=e[0],e=e[1];return t[0]=s[0]*i+s[2]*e+s[4],t[1]=s[1]*i+s[3]*e+s[5],t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});t=new I(2),I!=Float32Array&&(t[0]=0,t[1]=0);function n(t,e,s){e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s}for(var j,i=256,z=[];i--;)z[i]=(i+256).toString(16).substring(1);function o(){var t,e=0,s="";if(!j||256<i+16){for(j=Array(e=256);e--;)j[e]=256*Math.random()|0;e=i=0}for(;e<16;e++)t=j[i+e],s+=6==e?z[15&t|64]:8==e?z[63&t|128]:z[t],1&e&&1<e&&e<11&&(s+="-");return i++,s}var p=Array.isArray,t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function U(t,e){return t(e={exports:{}},e.exports),e.exports}var L="object"==typeof t&&t&&t.Object===Object&&t,t="object"==typeof self&&self&&self.Object===Object&&self,r=L||t||Function("return this")(),t=r.Symbol,e=Object.prototype,V=e.hasOwnProperty,Y=e.toString,a=t?t.toStringTag:void 0;var q=function(t){var e=V.call(t,a),s=t[a];try{var i=!(t[a]=void 0)}catch(t){}var n=Y.call(t);return i&&(e?t[a]=s:delete t[a]),n},G=Object.prototype.toString;var X=function(t){return G.call(t)},W=t?t.toStringTag:void 0;var s=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":(W&&W in Object(t)?q:X)(t)};var h=function(t){return null!=t&&"object"==typeof t};var K=function(t){return"symbol"==typeof t||h(t)&&"[object Symbol]"==s(t)},Z=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Q=/^\w*$/;var J=function(t,e){if(p(t))return!1;var s=typeof t;return!("number"!=s&&"symbol"!=s&&"boolean"!=s&&null!=t&&!K(t))||(Q.test(t)||!Z.test(t)||null!=e&&t in Object(e))};var g=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)};var $=function(t){return!!g(t)&&("[object Function]"==(t=s(t))||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t)},e=r["__core-js_shared__"],tt=(e=/[^.]+$/.exec(e&&e.keys&&e.keys.IE_PROTO||""))?"Symbol(src)_1."+e:"";var et=function(t){return!!tt&&tt in t},st=Function.prototype.toString;var it=function(t){if(null!=t){try{return st.call(t)}catch(t){}try{return t+""}catch(t){}}return""},nt=/^\[object .+?Constructor\]$/,e=Function.prototype,l=Object.prototype,e=e.toString,l=l.hasOwnProperty,rt=RegExp("^"+e.call(l).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var ot=function(t){return!(!g(t)||et(t))&&($(t)?rt:nt).test(it(t))};var at=function(t,e){return null==t?void 0:t[e]};var ht=function(t,e){return t=at(t,e),ot(t)?t:void 0},c=ht(Object,"create");function lt(t){return t=this.has(t)&&delete this.__data__[t],this.size-=t?1:0,t}var ct=Object.prototype.hasOwnProperty;function dt(t){var e,s=this.__data__;return c?"__lodash_hash_undefined__"===(e=s[t])?void 0:e:ct.call(s,t)?s[t]:void 0}var ut=Object.prototype.hasOwnProperty;function pt(t){var e=this.__data__;return c?void 0!==e[t]:ut.call(e,t)}function ft(t,e){var s=this.__data__;return this.size+=this.has(t)?0:1,s[t]=c&&void 0===e?"__lodash_hash_undefined__":e,this}function d(t){var e=-1,s=null==t?0:t.length;for(this.clear();++e<s;){var i=t[e];this.set(i[0],i[1])}}d.prototype.clear=function(){this.__data__=c?c(null):{},this.size=0},d.prototype.delete=lt,d.prototype.get=dt,d.prototype.has=pt,d.prototype.set=ft;var vt=d;var gt=function(t,e){return t===e||t!=t&&e!=e};var Et=function(t,e){for(var s=t.length;s--;)if(gt(t[s][0],e))return s;return-1},yt=Array.prototype.splice;function mt(t){var e=this.__data__;return!((t=Et(e,t))<0)&&(t==e.length-1?e.pop():yt.call(e,t,1),--this.size,!0)}function bt(t){var e=this.__data__;return(t=Et(e,t))<0?void 0:e[t][1]}function wt(t){return-1<Et(this.__data__,t)}function xt(t,e){var s=this.__data__,i=Et(s,t);return i<0?(++this.size,s.push([t,e])):s[i][1]=e,this}function u(t){var e=-1,s=null==t?0:t.length;for(this.clear();++e<s;){var i=t[e];this.set(i[0],i[1])}}u.prototype.clear=function(){this.__data__=[],this.size=0},u.prototype.delete=mt,u.prototype.get=bt,u.prototype.has=wt,u.prototype.set=xt;var Ot=u,St=ht(r,"Map");var Ct=function(t){var e=typeof t;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==t:null===t};var Mt=function(t,e){return t=t.__data__,Ct(e)?t["string"==typeof e?"string":"hash"]:t.map};function At(t){return t=Mt(this,t).delete(t),this.size-=t?1:0,t}function Rt(t){return Mt(this,t).get(t)}function Pt(t){return Mt(this,t).has(t)}function _t(t,e){var s=Mt(this,t),i=s.size;return s.set(t,e),this.size+=s.size==i?0:1,this}function E(t){var e=-1,s=null==t?0:t.length;for(this.clear();++e<s;){var i=t[e];this.set(i[0],i[1])}}E.prototype.clear=function(){this.size=0,this.__data__={hash:new vt,map:new(St||Ot),string:new vt}},E.prototype.delete=At,E.prototype.get=Rt,E.prototype.has=Pt,E.prototype.set=_t;var Bt=E;function Tt(i,n){if("function"!=typeof i||null!=n&&"function"!=typeof n)throw new TypeError("Expected a function");function r(){var t=arguments,e=n?n.apply(this,t):t[0],s=r.cache;return s.has(e)?s.get(e):(t=i.apply(this,t),r.cache=s.set(e,t)||s,t)}return r.cache=new(Tt.Cache||Bt),r}Tt.Cache=Bt;var Nt=Tt;var Dt=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Ft=/\\(\\)?/g,It=function(t){var e=(t=Nt(t,function(t){return 500===e.size&&e.clear(),t})).cache;return t}(function(t){var n=[];return 46===t.charCodeAt(0)&&n.push(""),t.replace(Dt,function(t,e,s,i){n.push(s?i.replace(Ft,"$1"):e||t)}),n});var kt=function(t,e){for(var s=-1,i=null==t?0:t.length,n=Array(i);++s<i;)n[s]=e(t[s],s,t);return n},e=t?t.prototype:void 0,Ht=e?e.toString:void 0;var jt=function t(e){if("string"==typeof e)return e;if(p(e))return kt(e,t)+"";if(K(e))return Ht?Ht.call(e):"";var s=e+"";return"0"==s&&1/e==-1/0?"-0":s};var zt=function(t){return null==t?"":jt(t)};var Ut=function(t,e){return p(t)?t:J(t,e)?[t]:It(zt(t))};var Lt=function(t){if("string"==typeof t||K(t))return t;var e=t+"";return"0"==e&&1/t==-1/0?"-0":e};var Vt=function(t,e){for(var s=0,i=(e=Ut(e,t)).length;null!=t&&s<i;)t=t[Lt(e[s++])];return s&&s==i?t:void 0};var y=function(t,e,s){return void 0===(t=null==t?void 0:Vt(t,e))?s:t};function Yt(t){var e=this.__data__,t=e.delete(t);return this.size=e.size,t}function qt(t){return this.__data__.get(t)}function Gt(t){return this.__data__.has(t)}function Xt(t,e){var s=this.__data__;if(s instanceof Ot){var i=s.__data__;if(!St||i.length<199)return i.push([t,e]),this.size=++s.size,this;s=this.__data__=new Bt(i)}return s.set(t,e),this.size=s.size,this}function m(t){t=this.__data__=new Ot(t);this.size=t.size}m.prototype.clear=function(){this.__data__=new Ot,this.size=0},m.prototype.delete=Yt,m.prototype.get=qt,m.prototype.has=Gt,m.prototype.set=Xt;var Wt=m,Kt=function(){try{var t=ht(Object,"defineProperty");return t({},"",{}),t}catch(t){}}();var Zt=function(t,e,s){"__proto__"==e&&Kt?Kt(t,e,{configurable:!0,enumerable:!0,value:s,writable:!0}):t[e]=s};var Qt=function(t,e,s){(void 0===s||gt(t[e],s))&&(void 0!==s||e in t)||Zt(t,e,s)};var Jt=function(h){return function(t,e,s){for(var i=-1,n=Object(t),r=s(t),o=r.length;o--;){var a=r[h?o:++i];if(!1===e(n[a],a,n))break}return t}}(),$t=U(function(t,e){var e=e&&!e.nodeType&&e,s=e&&t&&!t.nodeType&&t,s=s&&s.exports===e?r.Buffer:void 0,i=s?s.allocUnsafe:void 0;t.exports=function(t,e){return e?t.slice():(e=t.length,e=i?i(e):new t.constructor(e),t.copy(e),e)}}),te=r.Uint8Array;var ee=function(t){var e=new t.constructor(t.byteLength);return new te(e).set(new te(t)),e};var se=function(t,e){return e=e?ee(t.buffer):t.buffer,new t.constructor(e,t.byteOffset,t.length)};var ie=function(t,e){var s=-1,i=t.length;for(e=e||Array(i);++s<i;)e[s]=t[s];return e},ne=Object.create;function re(){}var oe=function(t){if(!g(t))return{};if(ne)return ne(t);re.prototype=t;t=new re;return re.prototype=void 0,t};var ae=function(e,s){return function(t){return e(s(t))}}(Object.getPrototypeOf,Object),he=Object.prototype;var le=function(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||he)};var ce=function(t){return"function"!=typeof t.constructor||le(t)?{}:oe(ae(t))};var l=function(t){return h(t)&&"[object Arguments]"==s(t)},t=Object.prototype,de=t.hasOwnProperty,ue=t.propertyIsEnumerable,pe=l(function(){return arguments}())?l:function(t){return h(t)&&de.call(t,"callee")&&!ue.call(t,"callee")};var fe=function(t){return"number"==typeof t&&-1<t&&t%1==0&&t<=9007199254740991};var ve=function(t){return null!=t&&fe(t.length)&&!$(t)};var ge=function(t){return h(t)&&ve(t)};function Ee(){return!1}var ye=U(function(t,e){var e=e&&!e.nodeType&&e,s=e&&t&&!t.nodeType&&t,s=s&&s.exports===e?r.Buffer:void 0,e=s?s.isBuffer:void 0;t.exports=e||Ee}),e=Function.prototype,t=Object.prototype,me=e.toString,be=t.hasOwnProperty,we=me.call(Object);var xe=function(t){return!(!h(t)||"[object Object]"!=s(t))&&(null===(t=ae(t))||"function"==typeof(t=be.call(t,"constructor")&&t.constructor)&&t instanceof t&&me.call(t)==we)},b={};b["[object Float32Array]"]=b["[object Float64Array]"]=b["[object Int8Array]"]=b["[object Int16Array]"]=b["[object Int32Array]"]=b["[object Uint8Array]"]=b["[object Uint8ClampedArray]"]=b["[object Uint16Array]"]=b["[object Uint32Array]"]=!0,b["[object Arguments]"]=b["[object Array]"]=b["[object ArrayBuffer]"]=b["[object Boolean]"]=b["[object DataView]"]=b["[object Date]"]=b["[object Error]"]=b["[object Function]"]=b["[object Map]"]=b["[object Number]"]=b["[object Object]"]=b["[object RegExp]"]=b["[object Set]"]=b["[object String]"]=b["[object WeakMap]"]=!1;function Oe(t){return h(t)&&fe(t.length)&&!!b[s(t)]}var l=function(e){return function(t){return e(t)}},e=U(function(t,e){var e=e&&!e.nodeType&&e,s=e&&t&&!t.nodeType&&t,i=s&&s.exports===e&&L.process,e=function(){try{var t=s&&s.require&&s.require("util").types;return t?t:i&&i.binding&&i.binding("util")}catch(t){}}();t.exports=e}),t=e&&e.isTypedArray,Se=t?l(t):Oe;var Ce=function(t,e){if(("constructor"!==e||"function"!=typeof t[e])&&"__proto__"!=e)return t[e]},Me=Object.prototype.hasOwnProperty;var Ae=function(t,e,s){var i=t[e];Me.call(t,e)&&gt(i,s)&&(void 0!==s||e in t)||Zt(t,e,s)};var Re=function(t,e,s,i){for(var n=!s,r=(s=s||{},-1),o=e.length;++r<o;){var a=e[r],h=i?i(s[a],t[a],a,s,t):void 0;void 0===h&&(h=t[a]),(n?Zt:Ae)(s,a,h)}return s};var Pe=function(t,e){for(var s=-1,i=Array(t);++s<t;)i[s]=e(s);return i},_e=/^(?:0|[1-9]\d*)$/;var Be=function(t,e){var s=typeof t;return!!(e=null==e?9007199254740991:e)&&("number"==s||"symbol"!=s&&_e.test(t))&&-1<t&&t%1==0&&t<e},Te=Object.prototype.hasOwnProperty;var Ne=function(t,e){var s,i=p(t),n=!i&&pe(t),r=!i&&!n&&ye(t),o=!i&&!n&&!r&&Se(t),a=i||n||r||o,h=a?Pe(t.length,String):[],l=h.length;for(s in t)!e&&!Te.call(t,s)||a&&("length"==s||r&&("offset"==s||"parent"==s)||o&&("buffer"==s||"byteLength"==s||"byteOffset"==s)||Be(s,l))||h.push(s);return h};var De=function(t){var e=[];if(null!=t)for(var s in Object(t))e.push(s);return e},Fe=Object.prototype.hasOwnProperty;var Ie=function(t){if(!g(t))return De(t);var e,s=le(t),i=[];for(e in t)("constructor"!=e||!s&&Fe.call(t,e))&&i.push(e);return i};var ke=function(t){return ve(t)?Ne(t,!0):Ie(t)};var He=function(t){return Re(t,ke(t))};var je=function(t,e,s,i,n,r,o){var a,h,l,c=Ce(t,s),d=Ce(e,s),u=o.get(d);u||((e=void 0===(u=r?r(c,d,s+"",t,e,o):void 0))&&(h=!(a=p(d))&&ye(d),l=!a&&!h&&Se(d),u=d,a||h||l?u=p(c)?c:ge(c)?ie(c):h?$t(d,!(e=!1)):l?se(d,!(e=!1)):[]:xe(d)||pe(d)?pe(u=c)?u=He(c):g(c)&&!$(c)||(u=ce(d)):e=!1),e&&(o.set(d,u),n(u,d,i,r,o),o.delete(d))),Qt(t,s,u)};var ze=function i(n,r,o,a,h){n!==r&&Jt(r,function(t,e){var s;h=h||new Wt,g(t)?je(n,r,e,o,i,a,h):(s=a?a(Ce(n,e),t,e+"",n,r,h):void 0,Qt(n,e,s=void 0===s?t:s))},ke)};function Ue(t){return t}var Le=function(t,e,s){switch(s.length){case 0:return t.call(e);case 1:return t.call(e,s[0]);case 2:return t.call(e,s[0],s[1]);case 3:return t.call(e,s[0],s[1],s[2])}return t.apply(e,s)},Ve=Math.max;var Ye=function(r,o,a){return o=Ve(void 0===o?r.length-1:o,0),function(){for(var t=arguments,e=-1,s=Ve(t.length-o,0),i=Array(s);++e<s;)i[e]=t[o+e];for(var e=-1,n=Array(o+1);++e<o;)n[e]=t[e];return n[o]=a(i),Le(r,this,n)}};var qe=function(t){return function(){return t}},Ge=Date.now;var Xe=function(s){var i=0,n=0;return function(){var t=Ge(),e=16-(t-n);if(n=t,0<e){if(800<=++i)return arguments[0]}else i=0;return s.apply(void 0,arguments)}}(Kt?function(t,e){return Kt(t,"toString",{configurable:!0,enumerable:!1,value:qe(e),writable:!0})}:Ue);var We=function(t,e){return Xe(Ye(t,e,Ue),t+"")};var Ke=function(t,e,s){if(!g(s))return!1;var i=typeof e;return!!("number"==i?ve(s)&&Be(e,s.length):"string"==i&&e in s)&&gt(s[e],t)};var Ze=function(a){return We(function(t,e){var s=-1,i=e.length,n=1<i?e[i-1]:void 0,r=2<i?e[2]:void 0,n=3<a.length&&"function"==typeof n?(i--,n):void 0;for(r&&Ke(e[0],e[1],r)&&(n=i<3?void 0:n,i=1),t=Object(t);++s<i;){var o=e[s];o&&a(t,o,s,n)}return t})}(function(t,e,s){ze(t,e,s)});const w={ICE_FRAME_EVENT:"ICE_FRAME_EVENT",BEFORE_RENDER:"BEFORE_RENDER",AFTER_RENDER:"AFTER_RENDER",ICE_CLICK:"ICE_CLICK",BEFORE_ADD:"BEFORE_ADD",AFTER_ADD:"AFTER_ADD",BEFORE_REMOVE:"BEFORE_REMOVE",AFTER_REMOVE:"AFTER_REMOVE",ROUND_FINISH:"ROUND_FINISH",HOOK_MOUSEDOWN:"HOOK_MOUSEDOWN",HOOK_MOUSEMOVE:"HOOK_MOUSEMOVE",HOOK_MOUSEUP:"HOOK_MOUSEUP",BEFORE_RESIZE:"BEFORE_RESIZE",AFTER_RESIZE:"AFTER_RESIZE",BEFORE_ROTATE:"BEFORE_ROTATE",AFTER_ROTATE:"AFTER_ROTATE",BEFORE_MOVE:"BEFORE_MOVE",AFTER_MOVE:"AFTER_MOVE"};class x{constructor(){var t,e,s=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};for(t in n(this,"originalEvent",void 0),n(this,"target",void 0),n(this,"param",void 0),s)this[t]=s[t];for(e in i)this[e]=i[e]}}let O=null;(O=window||global||{}).requestFrame=O.requestAnimationFrame||O.webkitRequestAnimationFrame||O.mozRequestAnimationFrame||O.oRequestAnimationFrame||O.msRequestAnimationFrame;var S=O;class C{constructor(){n(this,"listeners",{}),n(this,"suspendedEventNames",[])}on(t,e){var s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:S;this.listeners[t]||(this.listeners[t]=[]),this.off(t,e,s),this.listeners[t].push({callback:e,scope:s})}off(e,s){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:S,n=this.listeners[e];if(n){n=[...n];for(let t=0;t<n.length;t++){var r=n[t];if(r.callback===s&&r.scope===i)return void this.listeners[e].splice(t,1)}}}once(s,i){let n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:S;const r=this;r.on(s,function t(e){r.off(s,t,n),i.call(n,e)},n)}trigger(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(!this.listeners[t])return!1;if(this.suspendedEventNames.includes(t))return!1;let i;return e?((i=new x(e)).originalEvent=e,i.param={...s}):i=new x({type:t,timeStamp:(new Date).getTime(),param:{...s}}),this.listeners[t].forEach(t=>{let e=t.callback;t=t.scope;e.call(t,i)}),!0}suspend(t){t&&!this.suspendedEventNames.includes(t)&&this.suspendedEventNames.push(t)}resume(e){this.suspendedEventNames.splice(this.suspendedEventNames.findIndex(t=>t===e),1)}purgeEvents(){this.listeners={},this.suspendedEventNames=[]}hasListener(t,e){var s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:S;if(!this.listeners[t])return!1;var i=this.listeners[t];if(!i)return!1;for(let t=0;t<i.length;t++){var n=i[t];if(n.callback===e&&n.scope===s)return!0}return!1}}C.prototype.addEventListener=C.prototype.on,C.prototype.removeEventListener=C.prototype.off,C.prototype.dispatchEvent=C.prototype.trigger;class N{constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[0,0,0,0,0,0,0,0,0,0];n(this,"tl",[0,0]),n(this,"tr",[0,0]),n(this,"bl",[0,0]),n(this,"br",[0,0]),n(this,"center",[0,0]),this.tl=[t[0],t[1]],this.tr=[t[2],t[3]],this.bl=[t[4],t[5]],this.br=[t[6],t[7]],this.center=[t[8],t[9]]}static fromDimension(t,e,s,i){var n=[t,e],r=[t+s,e],o=[t,e+i],a=[t+s,e+i],t=[t+s/2,e+i/2];return new N([...n,...r,...o,...a,...t])}containsPoint(e){var{minX:t,minY:s,maxX:i,maxY:n}=this.getMinAndMaxPoint();if(e[0]<t||e[0]>i||e[1]<s||e[1]>n)return!1;let r=0,o;var a=this.getBoundingLines();for(let t=0;t<a.length;t++){var h,l=a[t];e[1]>l.o[1]&&e[1]>l.d[1]||e[1]<l.o[1]&&e[1]<l.d[1]||((o=l.o[0]===l.d[0]&&l.o[0]>=e[0]?l.o[0]:(h=(l.d[1]-l.o[1])/(l.d[0]-l.o[0]),l.o[0]+(e[1]-l.o[1])/h))>e[0]&&r++,r)}return 0!==r&&r%2==1}getBoundingLines(){return[{o:[...this.tl],d:[...this.tr]},{o:[...this.tr],d:[...this.br]},{o:[...this.br],d:[...this.bl]},{o:[...this.bl],d:[...this.tl]}]}getMinAndMaxPoint(){let e=this.tl[0],s=this.tl[1],i=this.tl[0],n=this.tl[1];const t=[this.tr,this.bl,this.br];return t.forEach(t=>{t[0]<e&&(e=t[0]),t[0]>i&&(i=t[0]),t[1]<s&&(s=t[1]),t[1]>n&&(n=t[1])}),{minX:e,minY:s,maxX:i,maxY:n}}containsBox(t){return!1}isIntersect(t){var e=this.tl[0],s=this.br[0],i=this.tl[1],n=this.br[1],r=t.tl[0],o=t.br[0],a=t.tl[1],t=t.br[1];return!(o<e||t<i||s<r||n<a)}transform(t){var e=v([],this.tl,t),s=v([],this.tr,t),i=v([],this.bl,t),n=v([],this.br,t),t=v([],this.center,t);return new N([...e,...s,...i,...n,...t])}union(t){return null}get width(){var t=this.br[0]-this.bl[0],e=this.br[1]-this.bl[1];return Math.hypot(t,e)}get height(){var t=this.br[0]-this.tr[0],e=this.br[1]-this.tr[1];return Math.hypot(t,e)}get left(){return this.tl[0]}set left(t){throw new Error("Can not set left to ICEBoundingBox directly.")}get top(){return this.tl[1]}set top(t){throw new Error("Can not set top to ICEBoundingBox directly.")}get centerX(){return this.center[0]}get centerY(){return this.center[1]}get centerPoint(){return this.center}}class Qe{constructor(){}static calcRotateAngleFromMatrix(t){let e=0;var s=t[0],t=t[1],i=Math.hypot(s,t),t=t/i;return e=Math.acos(s/i),t<0&&(e+=Math.PI/2),e*(180/Math.PI)}static calcScaleFromMatrix(t){var e=t[0],s=t[1],i=t[2],t=t[3];return[Math.hypot(e,s)/e,Math.hypot(i,t)/t]}}class M extends C{constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};super(),n(this,"ice",void 0),n(this,"root",void 0),n(this,"ctx",void 0),n(this,"evtBus",void 0),n(this,"parentNode",void 0),n(this,"props",{id:"ICE_"+o(),left:0,top:0,width:0,height:0,style:{fillStyle:"red",strokeStyle:"blue",lineWidth:1},animations:{},transform:{translate:[0,0],scale:[1,1],skew:[0,0],rotate:0},linearMatrix:[],composedMatrix:[],origin:"localCenter",localOrigin:[0,0],absoluteOrigin:[0,0],zIndex:M.instanceCounter++,display:!0,draggable:!0,transformable:!0,interactive:!0,linkable:!0,showMinBoundingBox:!0,showMaxBoundingBox:!0}),n(this,"state",{...this.props}),this.props=Ze(this.props,t),this.state=JSON.parse(JSON.stringify(this.props)),this.initEvents()}initEvents(){}render(){this.calcOriginalDimension(),this.applyStyle(),this.applyTransformToCtx(),this.doRender(),this.ctx.setTransform(1,0,0,1,0,0)}applyStyle(){Object.assign(this.ctx,{...this.props.style,...this.state.style})}calcOriginalDimension(){return{width:this.state.width,height:this.state.height}}calcLocalOrigin(){let t=[0,0];var e,s=this.state.origin;return s&&"localCenter"!==s||(s=this.state.width/2,e=this.state.height/2,t[0]=s,t[1]=e),this.state.localOrigin=t}calcAbsoluteOrigin(){var t=y(this,"state.transform.translate.0")+this.state.left,e=y(this,"state.transform.translate.1")+this.state.top;let s=[...this.calcLocalOrigin()];return s[0]+=t,s[1]+=e,this.parentNode&&(t=this.parentNode.state.localOrigin[0],e=this.parentNode.state.localOrigin[1],s=v([],s,[1,0,0,1,-t,-e]),t=this.parentNode.state.composedMatrix,s=v([],s,t)),this.state.absoluteOrigin=s}calcLinearMatrix(){o=new I(6),I!=Float32Array&&(o[1]=0,o[2]=0,o[4]=0,o[5]=0),o[0]=1,o[3]=1;var t,e,s,i,n,r,o,a=y(this,"state.transform.skew.0"),h=y(this,"state.transform.skew.1"),a=(r=[],i=o,a=a*k,h=h*k,a=Math.tan(a),h=Math.tan(h),r[0]=i[0],r[1]=i[1]+a,r[2]=i[2]+h,r[3]=i[3],r[4]=i[4],r[5]=i[5],o=r,y(this,"state.transform.rotate")),a=(h=[],i=a*k,a=(r=o)[0],t=o[1],l=o[2],e=o[3],n=o[4],r=o[5],s=Math.sin(i),i=Math.cos(i),h[0]=a*i+l*s,h[1]=t*i+e*s,h[2]=a*-s+l*i,h[3]=t*-s+e*i,h[4]=n,h[5]=r,o=h,y(this,"state.transform.scale.0")),l=y(this,"state.transform.scale.1");return t=[],s=[a,l],i=(e=o)[0],n=o[1],r=o[2],h=o[3],a=o[4],e=o[5],l=s[0],s=s[1],t[0]=i*l,t[1]=n*l,t[2]=r*s,t[3]=h*s,t[4]=a,t[5]=e,o=t,this.state.linearMatrix=o}calcAbsoluteLinearMatrix(){let t=this,e=t.calcLinearMatrix();for(;t.parentNode;)e=H([],t.parentNode.state.linearMatrix,e),t=t.parentNode;return this.state.absoluteLinearMatrix=e}composeMatrix(){var t=this.calcAbsoluteOrigin(),t=H([],[1,0,0,1,t[0],t[1]],this.calcAbsoluteLinearMatrix());return this.state.composedMatrix=t}applyTransformToCtx(){this.ctx.setTransform(...this.composeMatrix())}doRender(){var t;this.state.showMinBoundingBox&&(t=this.getMinBoundingBox(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.lineWidth=1,this.ctx.strokeStyle="#ff0000",this.ctx.fillStyle="rgba(0,0,0,0)",this.ctx.beginPath(),this.ctx.moveTo(t.tl[0],t.tl[1]),this.ctx.lineTo(t.tr[0],t.tr[1]),this.ctx.lineTo(t.br[0],t.br[1]),this.ctx.lineTo(t.bl[0],t.bl[1]),this.ctx.closePath(),this.ctx.stroke(),this.ctx.fill()),this.state.showMaxBoundingBox&&(t=this.getMaxBoundingBox(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.lineWidth=1,this.ctx.strokeStyle="#0000ff",this.ctx.fillStyle="rgba(0,0,0,0)",this.ctx.beginPath(),this.ctx.moveTo(t.tl[0],t.tl[1]),this.ctx.lineTo(t.tr[0],t.tr[1]),this.ctx.lineTo(t.br[0],t.br[1]),this.ctx.lineTo(t.bl[0],t.bl[1]),this.ctx.closePath(),this.ctx.stroke(),this.ctx.fill())}getMinBoundingBox(){var t=this.state.localOrigin[0],e=this.state.localOrigin[1],s=this.state.width,i=this.state.height;let n=new N([0-t,0-e,0-t+s,0-e,0-t,0-e+i,0-t+s,0-e+i,0,0]);return n=n.transform(this.composeMatrix())}getMaxBoundingBox(){let t=this.getMinBoundingBox();var{minX:e,minY:s,maxX:i,maxY:n}=t.getMinAndMaxPoint(),r=t.centerPoint;return t=new N([e,s,i,s,e,n,i,n,r[0],r[1]])}setState(t){Ze(this.state,t),this.ice&&(this.ice._dirty=!0)}setPosition(t,e){var s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:new x;this.trigger(w.BEFORE_MOVE,{...s,left:t,top:e}),this.setState({left:t,top:e}),this.trigger(w.AFTER_MOVE,{...s,left:t,top:e})}moveGlobalPosition(t,e){var s,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:new x;this.parentNode&&(t=(s=v([],[t,e],f([],this.parentNode.state.absoluteLinearMatrix)))[0],e=s[1]),this.setPosition(this.state.left+t,this.state.top+e,{...i,tx:t,ty:e})}setGlobalPosition(t,e){var s,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:new x;this.parentNode&&(t=(s=v([],[t,e],f([],this.parentNode.state.absoluteLinearMatrix)))[0],e=s[1]),this.setPosition(t,e,{...i,left:t,top:e})}setGlobalRotate(t){var e;this.parentNode&&(e=this.parentNode.state.absoluteLinearMatrix,t-=Qe.calcRotateAngleFromMatrix(e)),this.setState({transform:{rotate:t}})}localToGlobal(t,e){return v([],[t,e],this.state.composedMatrix)}globalToLocal(t,e){return v([],[t,e],f([],this.state.composedMatrix))}getRotateAngle(){var t=this.state.composedMatrix;return Qe.calcRotateAngleFromMatrix(t)}getLocalLeftTop(){var t=this.getMinBoundingBox(),e=t.width,s=t.height;return{left:t.centerX-t.width/2,top:t.centerY-t.height/2,width:e,height:s}}containsPoint(t,e){return this.getMinBoundingBox().containsPoint([t,e])}destory(){this.trigger(w.BEFORE_REMOVE,null,{component:this}),this.purgeEvents(),this.ice=null,this.ctx=null,this.root=null,this.evtBus=null,this.parentNode=null}}n(M,"instanceCounter",0);class Je extends M{constructor(){super({closePath:!0,...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}}),n(this,"path2D",new Path2D)}doRender(){this.createPathObject(),this.ctx.beginPath(),this.state.closePath&&this.ctx.fill(this.path2D),this.ctx.stroke(this.path2D),super.doRender()}}class $e extends Je{constructor(t){super({dots:[],transformedDots:[],closePath:!0,...t})}calcOriginalDimension(){this.calcDots();var t=this.calc4VertexPoints(),e=Math.abs(t[1][0]-t[0][0]),t=Math.abs(t[2][1]-t[0][1]);return this.state.width=e,this.state.height=t,{width:this.state.width,height:this.state.height}}calcLocalOrigin(){var e=super.calcLocalOrigin();for(let t=0;t<this.state.dots.length;t++){var s=v([],this.state.dots[t],[1,0,0,1,-e[0],-e[1]]);this.state.dots[t]=s}return e}createPathObject(){this.path2D=new Path2D;for(let t=0;t<this.state.dots.length;t++){var e=this.state.dots[t];0===t?this.path2D.moveTo(e[0],e[1]):this.path2D.lineTo(e[0],e[1])}return this.state.closePath&&this.path2D.closePath(),this.path2D}calcDots(){return this.state.dots=[],this.state.dots}calc4VertexPoints(){let e=0,s=0,i=0,n=0;for(let t=0;t<this.state.dots.length;t++){var r=this.state.dots[t];0===t?(e=r[0],i=r[0],s=r[1],n=r[1]):(r[0]<e&&(e=r[0]),r[0]>i&&(i=r[0]),r[1]<s&&(s=r[1]),r[1]>n&&(n=r[1]))}return[[e,s],[i,s],[e,n],[i,n]]}applyTransformToCtx(){super.applyTransformToCtx();var e=this.state.composedMatrix,s=this.state.dots;this.state.transformedDots=[];for(let t=0;t<s.length;t++){var i=v([],s[t],e);this.state.transformedDots.push(i)}}}class ts extends $e{constructor(){super({width:10,height:10,...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}})}calcDots(){var t=[this.state.width,0],e=[this.state.width,this.state.height],s=[0,this.state.height];return this.state.dots=[[0,0],t,e,s],this.state.dots}}var es=function(t){return"string"==typeof t||!p(t)&&h(t)&&"[object String]"==s(t)};var ss=function(t){return void 0===t};const is={linear:function(t,e,s,i){return t+(e-t)/s*(Date.now()-i)},easeInQuad:function(t,e,s,i){i=Date.now()-i;return t+(e-t)/s*(i/s)*i},easeOutQuad:function(t,e,s,i){i=Date.now()-i;return-(e-t)*(i/=s)*(i-2)+t},easeInOutQuad:function(t,e,s,i){let n=Date.now()-i;i=e-t;return(n/=s/2)<1?i/2*n*n+t:-i/2*(--n*(n-2)-1)+t},easeInQuart:function(t,e,s,i){i=Date.now()-i;return(e-t)*(i/=s)*i*i*i+t},easeOutQuart:function(t,e,s,i){return-(e-t)*((e=(Date.now()-i)/s-1)*e*e*e-1)+t},easeInOutQuart:function(t,e,s,i){let n=Date.now()-i;i=e-t;return(n/=s/2)<1?i/2*n*n*n*n+t:-i/2*((n-=2)*n*n*n-2)+t},easeInCubic:function(t,e,s,i){i=Date.now()-i;return(e-t)*(i/=s)*i*i+t},easeOutCubic:function(t,e,s,i){return(e-t)*((e=(Date.now()-i)/s-1)*e*e+1)+t},easeInOutCubic:function(t,e,s,i){let n=Date.now()-i;i=e-t;return(n/=s/2)<1?i/2*n*n*n+t:i/2*((n-=2)*n*n+2)+t}};class ns{constructor(t){n(this,"animationMap",new Map),n(this,"ice",void 0),this.ice=t}start(){return this.ice.evtBus.on(w.ICE_FRAME_EVENT,this.frameEventHandler,this),this}stop(){return this.ice.evtBus.off(w.ICE_FRAME_EVENT,this.frameEventHandler,this),this}frameEventHandler(t){this.animationMap.forEach(t=>{t.state.interactive=!1,this.tween(t),t.state.interactive=!0})}tween(s){let i={};var n,r=s.props.animations;let o=1;for(n in r){let t=r[n];if(t.finished){if(++o!==Object.keys(r).length)continue;this.remove(s);break}var a=t.from,h=t.to,l=t.duration;ss(t.startTime)&&(t.startTime=Date.now()),ss(t.easing)&&(t.easing="linear");let e=is[t.easing](a,h,l,t.startTime);e>h&&(e=h,t.finished=!0),i[n]=Math.floor(e)}return s.setState({...i}),s}add(t){this.animationMap.set(t.props.id,t)}remove(t){es(t)?this.animationMap.delete(t):this.animationMap.delete(t.props.id)}}class rs{constructor(t){n(this,"ice",void 0),n(this,"currentObj",void 0),this.ice=t}start(){return this.ice.evtBus.on("mousedown",this.mouseDownHandler,this),this}stop(){return this.ice.evtBus.off("mousedown",this.mouseDownHandler,this),this.ice.evtBus.off("mousemove",this.mouseMoveHandler,this),this.ice.evtBus.off("mouseup",this.mouseUpHandler,this),this}mouseDownHandler(t){t=t.target;t instanceof M?t.state.interactive&&t.state.draggable&&(this.currentObj=t,this.ice.evtBus.on("mousemove",this.mouseMoveHandler,this),this.ice.evtBus.on("mouseup",this.mouseUpHandler,this)):console.warn("DDManager: 点击在 canvas 画布上，没有点击任何图形。")}mouseMoveHandler(t){var e=t.movementX,s=t.movementY;return this.currentObj.moveGlobalPosition(e,s,t),!0}mouseUpHandler(t){this.ice.evtBus.off("mousemove",this.mouseMoveHandler,this),this.ice.evtBus.off("mouseup",this.mouseUpHandler,this)}}class os extends ts{constructor(t){super(t),n(this,"parentNode",null),n(this,"childNodes",[])}addChild(t){t.trigger(w.BEFORE_ADD),this.childNodes.push(t),t.trigger(w.AFTER_ADD)}addChildren(t){t.forEach(t=>{this.addChild(t)})}removeChild(t){t.destory(),this.childNodes.splice(this.childNodes.indexOf(t),1)}removeChildren(t){t.forEach(t=>{this.removeChild(t)})}destory(){this.removeChildren(this.childNodes),super.destory()}}class A extends os{constructor(t){super({...t,linkable:!1}),n(this,"_targetComponent",void 0)}doRender(){super.doRender(),this.setControlPositions()}moveGlobalPosition(t,e,s){super.moveGlobalPosition(t,e,s),this._targetComponent&&this._targetComponent.moveGlobalPosition(t,e,s)}}var R=function(t){return null==t},as=/\s/;var hs=function(t){for(var e=t.length;e--&&as.test(t.charAt(e)););return e},ls=/^\s+/;var cs=function(t){return t&&t.slice(0,hs(t)+1).replace(ls,"")},ds=/^[-+]0x[0-9a-f]+$/i,us=/^0b[01]+$/i,ps=/^0o[0-7]+$/i,fs=parseInt;var vs=function(t){if("number"==typeof t)return t;if(K(t))return NaN;if(g(t)&&(e="function"==typeof t.valueOf?t.valueOf():t,t=g(e)?e+"":e),"string"!=typeof t)return 0===t?t:+t;t=cs(t);var e=us.test(t);return e||ps.test(t)?fs(t.slice(2),e?2:8):ds.test(t)?NaN:+t};var gs=function(t){return t?(t=vs(t))===1/0||t===-1/0?17976931348623157e292*(t<0?-1:1):t==t?t:0:0===t?t:0};var Es=function(t){var e=(t=gs(t))%1;return t==t?e?t-e:t:0},ys=r.isFinite,ms=Math.min;var P=function(t){var n=Math[t];return function(t,e){var s,i;return t=vs(t),(e=null==e?0:ms(Es(e),292))&&ys(t)?(i=(zt(t)+"e").split("e"),s=n(i[0]+"e"+(+i[1]+e)),+((i=(zt(s)+"e").split("e"))[0]+"e"+(+i[1]-e))):n(t)}}("round");class bs{constructor(){throw new Error("GeoUtil is a static util class.")}static calcRotateAngle(t,e,s,i){t-=s,s=e-i,e=Math.hypot(t,s),i=(s/e<0?-1:1)*Math.acos(t/e)*180/Math.PI+360;return i%=360}}class ws extends $e{constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};super(ws.arrangeParam(t)),n(this,"startSlot",void 0),n(this,"endSlot",void 0)}static arrangeParam(t){let e=Ze({linkable:!1,lineType:"solid",lineWidth:2,arrow:"none",closePath:!1,points:[],showMinBoundingBox:!1,showMaxBoundingBox:!1},t);var s=e.points.length;return s<2&&(0===s?(e.points.push([0,0]),e.points.push([10,10])):1===s&&e.points.push([10,10])),(e=Ze(e,{left:t.points[0][0],top:t.points[0][1],transform:{translate:[0,0],scale:[1,1],skew:[0,0],rotate:0}})).style.lineWidth<=0&&(e.style.lineWidth=2),e}initEvents(){super.initEvents(),this.once(w.AFTER_RENDER,this.afterAddHandler,this)}afterAddHandler(t){this.evtBus.once(w.ROUND_FINISH,this.makeConnection,this)}makeConnection(){var{startSlotId:t,endSlotId:e}=this.props,t=this.ice.findComponent(t),e=this.ice.findComponent(e);t&&this.setSlot(t,"start"),e&&this.setSlot(e,"end")}calcLocalOrigin(){var t=[0,0];return this.state.localOrigin=t}calcDots(){let s=this.state.left,i=this.state.top;return this.state.dots=[],this.state.points.forEach(t=>{var e=t[0]-s,t=t[1]-i;this.state.dots.push([e,t])}),this.state.dots}addDot(t,e){this.state.points.splice(e,0,t),this.state.dots.splice(e,0,[t[0],t[1]])}rmDot(t){return!(this.state.points.length<3)&&(this.state.points.splice(t,1),this.state.dots.splice(t,1),!0)}calcOriginalDimension(){this.calcDots();var t=this.calc4VertexPoints(),e=Math.abs(t[1][0]-t[0][0]);let s=this.state.style.lineWidth;return this.isDotsOnSameLine()||(s=Math.abs(t[2][1]-t[0][1])),this.state.width=e,this.state.height=s,{width:this.state.width,height:this.state.height}}isDotsOnSameLine(){var e=this.state.points.length,s=P(this.state.points[0][0],2),i=P(this.state.points[0][1],2);let n=0;var r,o=[P(this.state.points[e-1][0],2)-s,P(this.state.points[e-1][1],2)-i];for(let t=0;t<e;t++){var a=this.state.points[t],a=[a[0]-s,a[1]-i];r=(r=o)[0]*a[1]-o[1]*a[0],(a=[])[0]=a[1]=0,a[2]=r,0===a[2]&&n++}return n===e}calc4VertexPoints(){return this.isDotsOnSameLine()?this.splitEndpointsTo4Points():super.calc4VertexPoints()}splitEndpointsTo4Points(){var t=this.state.points.length,e=this.state.points[t-1][0]-this.state.points[0][0],t=this.state.points[t-1][1]-this.state.points[0][1],s=this.getRotateAngle(),i=this.state.height,n=Math.cos(s*Math.PI/180)*i/2,s=Math.sin(s*Math.PI/180)*i/2;return[[0+(n=P(n,3)),0+(s=P(s,3))],[0-n,0-s],[e+n,t+s],[e-n,t-s]]}getMinBoundingBox(){var t=this.state.localOrigin[0],e=this.state.localOrigin[1],s=this.calc4VertexPoints();let i=new N([s[0][0]-t,s[0][1]-e,s[1][0]-t,s[1][1]-e,s[2][0]-t,s[2][1]-e,s[3][0]-t,s[3][1]-e,0,0]);return i=i.transform(this.state.composedMatrix)}setState(t){if(R(t.width)||delete t.width,R(t.height)||delete t.height,R(t.transform)||delete t.transform,!R(t.left)){var e=t.left-this.state.points[0][0];for(let t=0;t<this.state.points.length;t++)this.state.points[t][0]+=e}if(!R(t.top)){var s=t.top-this.state.points[0][1];for(let t=0;t<this.state.points.length;t++)this.state.points[t][1]+=s}var i;R(t.startPoint)||(this.state.points[0]=[...t.startPoint],this.state.left=this.state.points[0][0],this.state.top=this.state.points[0][1]),R(t.endPoint)||(i=this.state.points.length,this.state.points[i-1]=[...t.endPoint]),super.setState(t)}getRotateAngle(){var t,e;return this.isDotsOnSameLine()?(e=this.state.points.length,t=this.state.points[e-1][0]-this.state.points[0][0],e=this.state.points[e-1][1]-this.state.points[0][1],bs.calcRotateAngle(t,e,0,0)+90):super.getRotateAngle()}containsPoint(e,s){var i=this.getLines();for(let t=0;t<i.length;t++){var n=i[t],r=n.o[0],o=n.o[1],a=n.d[0],n=n.d[1],h=Math.hypot(a-r,n-o),r=Math.hypot(r-e,o-s),o=Math.hypot(a-e,n-s);if(h-3<=r+o&&r+o<=h+3)return!0}return!1}getLines(){const e=[];var s=this.state.transformedDots;if(!s||s.length<2)return e;for(let t=0;t<s.length-1;t++){var i=s[t][0],n=s[t][1],r=s[t+1][0],o=s[t+1][1];e.push({o:[i,n],d:[r,o]})}return e}syncPosition(t,e){var t=t.getMinBoundingBox(),s=t.center[0],t=t.center[1],s=this.globalToLocal(s,t),{left:t,top:i}=this.state,s=v([],s,[1,0,0,1,t,i]);"start"===e?this.setState({startPoint:[s[0],s[1]]}):"end"===e&&this.setState({endPoint:[s[0],s[1]]})}followStartSlot(t){this.syncPosition(this.startSlot,"start")}followEndSlot(t){this.syncPosition(this.endSlot,"end")}slotBeforeRemoveHandler(t){t=t.param.component;t&&(this.startSlot===t?this.deleteSlot(t,"start"):this.endSlot===t&&this.deleteSlot(t,"end"))}setSlot(t,e){t&&e&&(this.deleteSlot(t,e),this.setState({draggable:!1}),"start"===e?(this.startSlot=t,this.state.startSlotId=t.props.id,this.syncPosition(this.startSlot,"start"),this.startSlot.hostComponent.on(w.AFTER_MOVE,this.followStartSlot,this),this.startSlot.once(w.BEFORE_REMOVE,this.slotBeforeRemoveHandler,this)):"end"===e&&(this.endSlot=t,this.state.endSlotId=t.props.id,this.syncPosition(this.endSlot,"end"),this.endSlot.hostComponent.on(w.AFTER_MOVE,this.followEndSlot,this),this.endSlot.once(w.BEFORE_REMOVE,this.slotBeforeRemoveHandler,this)))}deleteSlot(t,e){"start"===e&&this.startSlot===t?(this.startSlot.hostComponent.off(w.AFTER_MOVE,this.followStartSlot,this),this.startSlot=null,this.state.startSlotId=""):"end"===e&&this.endSlot===t&&(this.endSlot.hostComponent.off(w.AFTER_MOVE,this.followEndSlot,this),this.endSlot=null,this.state.endSlotId=""),this.startSlot||this.endSlot||this.setState({draggable:!0})}}class xs extends Je{constructor(){let t={radiusX:20,radiusY:10,rotation:0,startAngle:0,endAngle:2*Math.PI,counterclockwise:!0,...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}};t.width=2*t.radiusX,t.height=2*t.radiusY,super(t)}createPathObject(){return this.path2D=new Path2D,this.path2D.ellipse(this.state.radiusX-this.state.localOrigin[0],this.state.radiusY-this.state.localOrigin[1],this.state.radiusX,this.state.radiusY,this.state.rotation,this.state.startAngle,this.state.endAngle,this.state.counterclockwise),this.path2D.closePath(),this.path2D}setState(t){R(t.radiusX)?R(t.width)||(t.radiusX=t.width/2):t.width=2*t.radiusX,R(t.radiusY)?R(t.height)||(t.radiusY=t.height/2):t.height=2*t.radiusY,super.setState(t)}}class Os extends xs{constructor(){let t={radius:10,...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}};t.radiusX=t.radius,t.radiusY=t.radius,super(t)}}class Ss extends Os{constructor(){super({linkable:!1,...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}})}initEvents(){super.initEvents(),this.on("mousedown",this.mosueDownHandler,this),this.on("mousemove",this.mosueMoveHandler,this),this.on("mouseup",this.mosueUpHandler,this),this.on(w.AFTER_MOVE,this.resizeEvtHandler,this)}mosueDownHandler(t){this.evtBus.trigger(w.HOOK_MOUSEDOWN,new x({target:this}))}mosueMoveHandler(t){this.evtBus.trigger(w.HOOK_MOUSEMOVE,new x({target:this}))}mosueUpHandler(t){this.evtBus.trigger(w.HOOK_MOUSEUP,new x({target:this}))}resizeEvtHandler(t){var e;this.parentNode&&(e=this.props.position,this.parentNode.trigger(w.BEFORE_RESIZE,new x(t,{position:e})),this.parentNode.trigger(w.AFTER_RESIZE,new x(t,{position:e})))}}class Cs extends A{constructor(t){super({...t,zIndex:Number.MAX_VALUE,linkable:!1,showMinBoundingBox:!1,showMaxBoundingBox:!1}),n(this,"controlSize",16),n(this,"startControl",void 0),n(this,"endControl",void 0),this.initControls()}initControls(){var t=1,e=this.state.width,s=this.state.height,i=this.controlSize/2;this.startControl=new Ss({zIndex:Number.MAX_VALUE-+t,display:!1,left:-i,top:-i,width:this.controlSize,height:this.controlSize,style:{strokeStyle:"#0c09d4",fillStyle:"#3ce92c",lineWidth:1},position:"start"}),this.addChild(this.startControl),this.endControl=new Ss({zIndex:Number.MAX_VALUE-2,display:!1,left:e-i,top:s-i,width:this.controlSize,height:this.controlSize,style:{strokeStyle:"#0c09d4",fillStyle:"#3ce92c",lineWidth:1},position:"end"}),this.addChild(this.endControl)}initEvents(){this.on(w.AFTER_RESIZE,this.resizeEvtHandler,this)}enable(){this.setState({display:!0}),this.resume(w.AFTER_RESIZE),this.showHooks()}disable(){this.setState({display:!1}),this.suspend(w.AFTER_RESIZE),this.hideHooks()}setControlPositions(){}resizeEvtHandler(n){if(this.targetComponent){var r=n.position,o=n.movementX,a=n.movementY,n=this.targetComponent.state,h=n.points.length;let t=n.points[0][0],e=n.points[0][1],s=n.points[h-1][0],i=n.points[h-1][1];h=v([],[o,a],f([],n.absoluteLinearMatrix)),o=h[0],a=h[1];switch(r){case"start":t+=o,e+=a;break;case"end":s+=o,i+=a}this.targetComponent.setState({startPoint:[t,e],endPoint:[s,i]})}}updatePosition(){var t,e,s;this.targetComponent&&(this.setState({left:0,top:-5,width:3,height:3,transform:{translate:[0,0],scale:[1,1],skew:[0,0],rotate:0}}),t=this.controlSize/2,s=this.targetComponent.state.points.length,e=this.targetComponent.state.points[0],s=this.targetComponent.state.points[s-1],e=[e[0],e[1]],s=[s[0],s[1]],this.startControl.setState({left:e[0]-t,top:e[1]-t}),this.endControl.setState({left:s[0]-t,top:s[1]-t}))}set targetComponent(t){(this._targetComponent=t)?(this.updatePosition(),t.on(w.AFTER_MOVE,this.updatePosition,this)):t.off(w.AFTER_MOVE,this.updatePosition,this)}get targetComponent(){return this._targetComponent}showHooks(){this.startControl.setState({display:!0}),this.endControl.setState({display:!0})}hideHooks(){this.startControl.setState({display:!1}),this.endControl.setState({display:!1})}}class Ms extends ts{constructor(t){super({position:"l",direction:"x",quadrant:1,...t,linkable:!1})}initEvents(){super.initEvents(),this.on(w.AFTER_MOVE,this.resizeEvtHandler,this)}resizeEvtHandler(n){if(this.parentNode){var r=n["quadrant"],o=n.movementX,a=n.movementY,h=this.parentNode.state;let t=h.left,e=h.top,s=h.width,i=h.height;h=v([],[o,a],f([],h.absoluteLinearMatrix)),o=h[0],a=h[1];switch(r){case 1:t-=o,e+=a,s+=2*o,i-=2*a;break;case 2:t+=o,e+=a,s-=2*o,i-=2*a;break;case 3:t+=o,e-=a,s-=2*o,i+=2*a;break;case 4:t-=o,e-=a,s+=2*o,i+=2*a;break;case 5:e+=a,i-=2*a;break;case 6:e-=a,i+=2*a;break;case 7:t+=o,s-=2*o;break;case 8:t-=o,s+=2*o}h={top:e,left:t,width:Math.abs(s),height:Math.abs(i)};this.parentNode.trigger(w.BEFORE_RESIZE,new x(n,{quadrant:r})),this.parentNode.setState(h),this.parentNode.trigger(w.AFTER_RESIZE,new x(n,{quadrant:r}))}}moveGlobalPosition(s,i){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:new x,n=0<s?1:-1,r=0<i?1:-1,o=this.parentNode.state,a=o.localOrigin,h=o.width,l=o.height,o=v([],[s,i],f([],o.absoluteLinearMatrix));s=o[0],i=o[1];let{left:c,top:d,quadrant:u}=this.state;o=this.state.width/2;let p=0;if("x"===this.state.direction)c+=s,0===P(c)&&(c=.5*n),p=0<c+o-a[0]?8:7;else if("y"===this.state.direction)d+=i,0===P(d)&&(d=.5*r),p=0<d+o-a[1]?6:5;else if("xy"===this.state.direction){let t=-h/2;r=-l/2/(t=0===P(t)?.5*n:t);let e=h/2;h=-l/2/(e=0===P(e)?.5*n:e);i=2===u||4==u?r*(c+o-a[0]+s)-(d+o-a[1]):h*(c+o-a[0]+s)-(d+o-a[1]),c+=s,d+=i,p=0<c+o-a[0]?0<d+o-a[1]?4:1:0<d+o-a[1]?3:2}u!==p&&this.parentNode.toggleControlQuadrant(this,p),this.setPosition(c,d,new x(t,{left:c,top:d,tx:s,ty:i,quadrant:p}))}}class As extends Os{constructor(t){super({props:t,linkable:!1})}initEvents(){super.initEvents(),this.on(w.AFTER_MOVE,this.rotateEvtHandler,this)}rotateEvtHandler(t){var e;this.parentNode&&(e=this.parentNode.state.absoluteOrigin,t={transform:{rotate:bs.calcRotateAngle(t.offsetX,t.offsetY,e[0],e[1])+90}},this.parentNode.trigger(w.BEFORE_ROTATE,new x(t)),this.parentNode.setState(t),this.parentNode.trigger(w.AFTER_ROTATE,new x(t)))}}class Rs extends A{constructor(t){super({...t,zIndex:Number.MAX_VALUE,linkable:!1,showMinBoundingBox:!1,showMaxBoundingBox:!1}),n(this,"rotateControlInstance",void 0),n(this,"rotateControlSize",8),n(this,"rotateControlffsetY",60),n(this,"resizeControlInstanceCache",[]),n(this,"resizeControlSize",16),this.initControls()}initControls(){var t=this.state.width,e=this.state.height,s=t/2,i=e/2,n=this.resizeControlSize/2;let r=[{direction:"xy",quadrant:2,position:[-n,-n]},{direction:"y",quadrant:5,position:[s-n,-n]},{direction:"xy",quadrant:1,position:[t-n,-n]},{direction:"x",quadrant:8,position:[t-n,i-n]},{direction:"xy",quadrant:4,position:[t-n,e-n]},{direction:"y",quadrant:6,position:[s-n,e-n]},{direction:"xy",quadrant:3,position:[-n,e-n]},{direction:"x",quadrant:7,position:[-n,i-n]}],o=1;this.resizeControlInstanceCache=[],r.forEach(t=>{t=new Ms({zIndex:Number.MAX_VALUE-o++,display:!1,left:t.position[0],top:t.position[1],width:this.resizeControlSize,height:this.resizeControlSize,style:{strokeStyle:"#8b0000",fillStyle:"#CC3300",lineWidth:1},direction:t.direction,quadrant:t.quadrant});this.addChild(t),this.resizeControlInstanceCache.push(t)});t=this.state.width/2-this.rotateControlSize,s=-this.rotateControlffsetY;this.rotateControlInstance=new As({zIndex:Number.MAX_VALUE-o++,display:!1,left:t,top:s,radius:this.rotateControlSize,style:{strokeStyle:"#8b0000",fillStyle:"#CC3300",lineWidth:1}}),this.addChild(this.rotateControlInstance)}initEvents(){super.initEvents(),this.on(w.AFTER_RESIZE,this.resizeEvtHandler,this),this.on(w.AFTER_ROTATE,this.rotateEvtHandler,this)}enable(){this.rotateControlInstance.setState({display:!0}),this.resizeControlInstanceCache.forEach(t=>{t.setState({display:!0})}),this.setState({display:!0}),this.resume(w.AFTER_RESIZE),this.resume(w.AFTER_ROTATE)}disable(){this.rotateControlInstance.setState({display:!1}),this.resizeControlInstanceCache.forEach(t=>{t.setState({display:!1})}),this.setState({display:!1}),this.suspend(w.AFTER_RESIZE),this.suspend(w.AFTER_ROTATE)}setControlPositions(){let s=this.state.width,i=this.state.height,n=s/2,r=i/2,o=this.resizeControlSize/2;this.resizeControlInstanceCache.forEach(t=>{let e=[0,0];switch(t.state.quadrant){case 1:e=[s-o,-o];break;case 2:e=[-o,-o];break;case 3:e=[-o,i-o];break;case 4:e=[s-o,i-o];break;case 5:e=[n-o,-o];break;case 6:e=[n-o,i-o];break;case 7:e=[-o,r-o];break;case 8:e=[s-o,r-o]}t.setState({left:e[0],top:e[1]})});var t=this.state.width/2-this.rotateControlSize,e=-this.rotateControlffsetY;this.rotateControlInstance.setState({left:t,top:e})}rotateEvtHandler(t){var e;this.targetComponent&&(e=this.state.transform["rotate"],this.targetComponent.setGlobalRotate(e))}resizeEvtHandler(n){if(this.targetComponent){var r=n["quadrant"],o=n.movementX,a=n.movementY,n=this.targetComponent.state;let t=n.left,e=n.top,s=n.width,i=n.height;n=v([],[o,a],f([],n.absoluteLinearMatrix)),o=n[0],a=n[1];switch(r){case 1:t-=o,e+=a,s+=2*o,i-=2*a;break;case 2:t+=o,e+=a,s-=2*o,i-=2*a;break;case 3:t+=o,e-=a,s-=2*o,i+=2*a;break;case 4:t-=o,e-=a,s+=2*o,i+=2*a;break;case 5:e+=a,i-=2*a;break;case 6:e-=a,i+=2*a;break;case 7:t+=o,s-=2*o;break;case 8:t-=o,s+=2*o}this.targetComponent.setState({left:t,top:e,width:Math.abs(s),height:Math.abs(i)})}}updatePanel(){var t,e,s,i,n;this.targetComponent&&(t=this.targetComponent.getRotateAngle(),{left:e,top:s,width:i,height:n}=this.targetComponent.getLocalLeftTop(),this.setState({left:e,top:s,width:i,height:n,transform:{rotate:t}}))}set targetComponent(t){(this._targetComponent=t)?(this.updatePanel(),t.on(w.AFTER_MOVE,this.updatePanel,this)):t.off(w.AFTER_MOVE,this.updatePanel,this)}get targetComponent(){return this._targetComponent}toggleControlQuadrant(t,s){this.resizeControlInstanceCache.forEach(e=>{if(e.state.quadrant===s){let t=0;switch(s){case 1:t=3;break;case 2:t=4;break;case 3:t=1;break;case 4:t=2;break;case 5:t=6;break;case 6:t=5;break;case 7:t=8;break;case 8:t=7}e.setState({quadrant:t})}}),t.setState({quadrant:s})}}class Ps{constructor(t){n(this,"ice",void 0),n(this,"transformControlPanel",void 0),n(this,"lineControlPanel",void 0),this.ice=t,this.transformControlPanel=new Rs({left:500,top:100,width:100,height:100,style:{strokeStyle:"#8b0000",fillStyle:"rgba(255, 255, 49, 0.2)",lineWidth:1},transform:{rotate:45}}),this.ice.addChild(this.transformControlPanel),this.transformControlPanel.disable(),this.lineControlPanel=new Cs({left:700,top:50,width:100,height:100,style:{strokeStyle:"rgba(255, 255, 49, 0)",fillStyle:"rgba(255, 255, 49, 0)",lineWidth:1}}),this.ice.addChild(this.lineControlPanel),this.lineControlPanel.disable()}start(){return this.ice.evtBus.on("mousedown",this.mouseDownHandler,this),this}stop(){return this.ice.evtBus.off("mousedown",this.mouseDownHandler,this),this}mouseDownHandler(t){t=t.target;if(!(t instanceof M&&t.state.interactive&&t.state.transformable))return this.lineControlPanel.disable(),void this.transformControlPanel.disable();t&&(t instanceof A||t.parentNode instanceof A)||(this.ice.selectionList=[t],this.lineControlPanel.disable(),this.transformControlPanel.disable(),t instanceof ws?(this.lineControlPanel.targetComponent=t,this.lineControlPanel.enable()):(this.transformControlPanel.targetComponent=t,this.transformControlPanel.enable()))}}const _s=[["mousedown","ICE_MOUSEDOWN"],["mouseup","ICE_MOUSEUP"],["mousemove","ICE_MOUSEMOVE"],["click","ICE_CLICK"],["dbclick","ICE_DBCLICK"],["contextmenu","ICE_CONTEXTMENU"]];class Bs{constructor(t){n(this,"selectionCandidates",[]),n(this,"ice",void 0),n(this,"_stopped",!1),this.ice=t}start(){let i=null;return _s.forEach(t=>{const e=t[1],s=t[0];this.ice.evtBus.on(e,t=>{this._stopped||((i="ICE_MOUSEMOVE"!==e?this.findTargetComponent(t.clientX,t.clientY):i)&&(t.target=i).trigger(s,t),this.ice.evtBus.trigger(s,t))})}),this}set stopped(t){this._stopped=t}get stopped(){return this._stopped}findTargetComponent(t,e){if(this._stopped)return null;var s=t-this.ice.canvasBoundingClientRect.left,i=e-this.ice.canvasBoundingClientRect.top,n=this.ice.childNodes;for(let t=0;t<n.length;t++){var r=n[t];this.traverse(s,i,r)}this.selectionCandidates.sort((t,e)=>t.zIndex-e.zIndex);t=this.selectionCandidates[0];return this.selectionCandidates=[],t}traverse(e,s,t){var i,n;this._stopped||(t.childNodes&&t.childNodes.length&&t.childNodes.forEach(t=>{this.traverse(e,s,t)}),{interactive:i,display:n}=t.state,t.containsPoint(e,s)&&i&&n&&this.selectionCandidates.push(t))}}class Ts extends C{constructor(){super()}}const _={evtBuses:[],start:function(){S&&S.addEventListener&&_.evtBuses.forEach(s=>{_s.forEach(e=>{S.addEventListener(e[0],t=>{s.trigger(e[1],t)})})})},regitserEvtBus:function(t){_.evtBuses.includes(t)||_.evtBuses.push(t)},delEvtBus:function(t){_.evtBuses.includes(t)&&_.evtBuses.splice(_.evtBuses.indexOf(t),1)}},B={evtBuses:[],stopped:!1,frameCallback:function(){B.evtBuses.forEach(t=>{B.stopped||t.trigger(w.ICE_FRAME_EVENT)}),B.stopped||S.requestFrame(B.frameCallback)},start:function(){B.stopped=!1,S.requestFrame(B.frameCallback)},stop:function(){B.stopped=!0},pause:function(){},resume:function(){},regitserEvtBus:function(t){B.evtBuses.includes(t)||B.evtBuses.push(t)},delEvtBus:function(t){B.evtBuses.includes(t)&&B.evtBuses.splice(B.evtBuses.indexOf(t),1)}};class T extends Os{constructor(){super({linkable:!1,draggable:!1,position:"T",...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}}),n(this,"_hostComponent",void 0)}initEvents(){super.initEvents(),this.once(w.BEFORE_RENDER,this.afterAddHandler,this),this.once(w.BEFORE_REMOVE,this.beforeRemoveHandler,this)}afterAddHandler(t){this.evtBus.on(w.HOOK_MOUSEDOWN,this.hookMouseDownHandler,this),this.evtBus.on(w.HOOK_MOUSEMOVE,this.hookMouseMoveHandler,this),this.evtBus.on(w.HOOK_MOUSEUP,this.hookMouseUpHandler,this)}beforeRemoveHandler(t){this.evtBus.off(w.HOOK_MOUSEDOWN,this.hookMouseDownHandler,this),this.evtBus.off(w.HOOK_MOUSEMOVE,this.hookMouseMoveHandler,this),this.evtBus.off(w.HOOK_MOUSEUP,this.hookMouseUpHandler,this),this._hostComponent=null}hookMouseDownHandler(t){this.setState({display:!0})}hookMouseMoveHandler(t){let e=t.target;this.isIntersectWithHook(e)?(this.setState({style:{fillStyle:"#fffb00"}}),e._currentAboveSlot=this,e.setState({style:{fillStyle:"#fffb00"}})):(this.setState({style:{fillStyle:"#3ce92c"}}),e._currentAboveSlot===this&&e.setState({style:{fillStyle:"#3ce92c"}}))}hookMouseUpHandler(t){let e=t.target,s=e.parentNode.targetComponent;t=e.state.position;this.isIntersectWithHook(e)?s&&s.setSlot(this,t):s&&s.deleteSlot(this,t),this.setState({display:!1,style:{fillStyle:"#3ce92c"}}),e.setState({style:{fillStyle:"#3ce92c"}})}isIntersectWithHook(t){let e=this.getMaxBoundingBox();t=t.getMaxBoundingBox();return!!e.isIntersect(t)}set hostComponent(t){this._hostComponent=t}get hostComponent(){return this._hostComponent}}class Ns{constructor(t){n(this,"slotRadius",10),n(this,"ice",void 0),this.ice=t}start(){return this.ice.renderer.on(w.AFTER_RENDER,this.afterRenderHandler,this),this}stop(){return this.ice.renderer.off(w.AFTER_RENDER,this.afterRenderHandler,this),this}afterRenderHandler(t){t=t.param.component;t&&t.state.linkable&&(t.linkSlots&&t.linkSlots.length||this.createLinkSlots(t),this.setSlotPositions(t))}createLinkSlots(t){var e=t.props.slotIds||[];let s=new T({id:e[0]||"ICE_"+o(),display:!1,transformable:!1,radius:this.slotRadius,position:"T",style:{strokeStyle:"#0c09d4",fillStyle:"#3ce92c",lineWidth:1}}),i=(s.hostComponent=t,this.ice.addChild(s),new T({id:e[1]||"ICE_"+o(),display:!1,transformable:!1,radius:this.slotRadius,position:"R",style:{strokeStyle:"#0c09d4",fillStyle:"#3ce92c",lineWidth:1}})),n=(i.hostComponent=t,this.ice.addChild(i),new T({id:e[2]||"ICE_"+o(),display:!1,transformable:!1,radius:this.slotRadius,position:"B",style:{strokeStyle:"#0c09d4",fillStyle:"#3ce92c",lineWidth:1}})),r=(n.hostComponent=t,this.ice.addChild(n),new T({id:e[3]||"ICE_"+o(),display:!1,transformable:!1,radius:this.slotRadius,position:"L",style:{strokeStyle:"#0c09d4",fillStyle:"#3ce92c",lineWidth:1}}));r.hostComponent=t,this.ice.addChild(r),t.linkSlots=[s,i,n,r],t.state.slotIds=[s.props.id,i.props.id,n.props.id,r.props.id]}setSlotPositions(t){let i=t.getMinBoundingBox();t.linkSlots.forEach(t=>{let e=0,s=0;switch(t.state.position){case"T":e=i.center[0]-this.slotRadius,s=i.tl[1]-this.slotRadius;break;case"R":e=i.tr[0]-this.slotRadius,s=i.center[1]-this.slotRadius;break;case"B":e=i.center[0]-this.slotRadius,s=i.br[1]-this.slotRadius;break;case"L":e=i.bl[0]-this.slotRadius,s=i.center[1]-this.slotRadius}t.setState({left:e,top:s})})}}class Ds extends M{constructor(){super({width:100,height:100,...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}})}initEvents(){}doRender(){let t=new Image;t.src="data:image/png;base64,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",this.ctx.drawImage(t,0-this.state.localOrigin[0],0-this.state.localOrigin[1],this.state.width,this.state.height),super.doRender()}}class D{constructor(t,e){this.startPoint=t,this.endPoint=e}contains(t,e){var s=Math.hypot(this.endPoint.x-this.startPoint.x,this.endPoint.y-this.startPoint.y),i=Math.hypot(t-this.startPoint.x,e-this.startPoint.y),t=Math.hypot(t-this.endPoint.x,e-this.endPoint.y);return s-3<=i+t&&i+t<=s+3}}class F{constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;this.x=t,this.y=e}static load(t){return new F(Number(t.x),Number(t.y))}static cloneArray(e){let s=[];for(let t=0;t<e.length;t++)s.push(e[t].clone());return s}equals(t){return this.x==t.x&&this.y==t.y}clone(){return new F(this.x,this.y)}}class Fs extends ws{constructor(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};super(Fs.arrangeParam(t))}static arrangeParam(t){return R(t.startPoint)&&(t.startPoint=[0,0]),R(t.endPoint)&&(t.endPoint=[10,10]),t.points=[[...t.startPoint],[...t.endPoint]],t={escapeDistance:30,...t}}calcDots(){var t=this.interpolate();let{left:e,top:s}=this.state,i=t[0][2];return this.state.points=[],this.state.dots=[],i.forEach(t=>{this.state.points.push([t.x,t.y]),this.state.dots.push([t.x-e,t.y-s])}),this.state.dots}interpolate(){var t=this.state.points.length,e=this.state.points[0][0],s=this.state.points[0][1],i=this.state.points[t-1][0],t=this.state.points[t-1][1];let n=new F(e,s);var r=new F(i,t);let o=[],a=null,h=null,l=[],c=new N,d=new N;if(this.startSlot){c=this.startSlot.hostComponent.getMinBoundingBox(),o[0]=new F(n.x,c.tl[1]-this.state.escapeDistance),o[1]=new F(c.tr[0]+this.state.escapeDistance,n.y),o[2]=new F(n.x,c.br[1]+this.state.escapeDistance),o[3]=new F(c.tl[0]-this.state.escapeDistance,n.y),a=o[0];for(let t=1;t<o.length;t++)this.distance(n,o[t])<this.distance(n,a)&&(a=o[t])}if(this.endSlot){d=this.endSlot.hostComponent.getMinBoundingBox(),o[0]=new F(r.x,d.tl[1]-this.state.escapeDistance),o[1]=new F(d.tr[0]+this.state.escapeDistance,r.y),o[2]=new F(r.x,d.br[1]+this.state.escapeDistance),o[3]=new F(d.tl[0]-this.state.escapeDistance,r.y),h=o[0];for(let t=1;t<o.length;t++)this.distance(r,o[t])<this.distance(r,h)&&(h=o[t])}let u=0,p=[n];a&&(p.push(a),u=1),h&&p.push(h),p.push(r);e=F.cloneArray(p),l.push(["s0","s0",e]),s=F.cloneArray(p);let f=F.cloneArray(s),v=(f.splice(u+1,0,new F(f[u].x,f[u+1].y)),l.push(["s1","s1_1",f]),F.cloneArray(s)),g=(v.splice(u+1,0,new F(v[u+1].x,v[u].y)),l.push(["s1","s1_2",v]),F.cloneArray(s));i=new F((g[u].x+g[u+1].x)/2,g[u].y),t=new F((g[u].x+g[u+1].x)/2,g[u+1].y);g.splice(u+1,0,i,t),l.push(["s2","s2_1",g]);let E=F.cloneArray(s);e=new F(E[u].x,(E[u].y+E[u+1].y)/2),i=new F(E[u+1].x,(E[u].y+E[u+1].y)/2);E.splice(u+1,0,e,i),l.push(["s2","s2_2",E]);let y=F.cloneArray(s),m=[y[u].x+20,y[u+1].x+20];c&&m.push(c.br[0]+20),d&&m.push(d.br[0]+20);t=this.max(m),e=new F(t,y[u].y),i=new F(t,y[u+1].y);y.splice(u+1,0,e,i),l.push(["s2","s2_3",y]);let b=F.cloneArray(s),w=[b[u].y-20,b[u+1].y-20];c&&w.push(c.tl[1]-20),d&&w.push(d.tl[1]-20);t=this.min(w),e=new F(b[u].x,t),i=new F(b[u+1].x,t);b.splice(u+1,0,e,i),l.push(["s2","s2_4",b]);let x=F.cloneArray(s),O=[x[u].x-20,x[u+1].x-20];c&&O.push(c.tl[0]-20),d&&O.push(d.tl[0]-20);t=this.min(O),e=new F(t,x[u].y),i=new F(t,x[u+1].y);x.splice(u+1,0,e,i),l.push(["s2","s2_5",x]);let S=F.cloneArray(s),C=[S[u].y+20,S[u+1].y+20];c&&C.push(c.tl[1]+c.height+20),d&&C.push(d.tl[1]+d.height+20);t=this.max(C),e=new F(S[u].x,t),i=new F(S[u+1].x,t);S.splice(u+1,0,e,i),l.push(["s2","s2_6",S]);let M=[];for(let t=0;t<l.length;t++){var A=l[t][2];this.orthogonalPath(A)&&M.push(l[t])}if(l=M,!n.equals(r)){let e=[];for(let t=0;t<l.length;t++){var R=l[t][2];this.forwardPath(R)&&e.push(l[t])}(l=e).length}let P=[];for(let i=0;i<l.length;i++){let t=l[i][2],e=!1,s=t.slice();(d||c)&&(s=s.slice(1,s.length-1)),c&&(e=e||this.polylineIntersectsRectangle(s,c)),(e=d?e||this.polylineIntersectsRectangle(s,d):e)||P.push(l[i])}(l=0!=P.length?P:l).length;var _=l[0][2].length;let B=[];for(let t=0;t<l.length;t++)l[t][2].length==_&&B.push(l[t]);l=B;let T=0;for(let t=0;t<l.length;t++)this.scorePath(l[T][2])<this.scorePath(l[t][2])&&(T=t);return l=[l[T]]}orthogonalPath(e){if(e.length<=1)return!0;for(let t=0;t<e.length-1;t++)if(e[t].x!=e[t+1].x&&e[t].y!=e[t+1].y)return!1;return!0}lineIntersectsLine(t,e){var s,i,n,r;return t.startPoint.x==t.endPoint.x&&e.startPoint.x==e.endPoint.x?t.startPoint.x==e.startPoint.x&&(t.contains(e.startPoint.x,e.startPoint.y)||t.contains(e.endPoint.x,e.endPoint.y)):t.startPoint.x==t.endPoint.x||e.startPoint.x==e.endPoint.x?(t.startPoint.x==t.endPoint.x&&(n=t,t=e,e=n),n=(t.endPoint.y-t.startPoint.y)/(t.endPoint.x-t.startPoint.x),s=t.startPoint.y-n*t.startPoint.x,i=e.startPoint.x,t.contains(i,n=n*i+s)&&e.contains(i,n)):(s=(t.endPoint.y-t.startPoint.y)/(t.endPoint.x-t.startPoint.x),i=t.startPoint.y-s*t.startPoint.x,n=(e.endPoint.y-e.startPoint.y)/(e.endPoint.x-e.startPoint.x),r=e.startPoint.y-n*e.startPoint.x,s==n?i==r&&(t.contains(e.startPoint.x,e.startPoint.y)||t.contains(e.endPoint.x,e.endPoint.y)):t.contains(t=(r-i)/(s-n),r=s*t+i)&&e.contains(t,r))}polylineIntersectsRectangle(e,t){var s=2<arguments.length&&void 0!==arguments[2]&&arguments[2];let i=[];i.push(new D(new F(t.x1,t.y1),new F(t.x2,t.y1))),i.push(new D(new F(t.x2,t.y1),new F(t.x2,t.y2))),i.push(new D(new F(t.x2,t.y2),new F(t.x1,t.y2))),i.push(new D(new F(t.x1,t.y2),new F(t.x1,t.y1)));for(let t=0;t<e.length-1;t++){var n=new D(e[t],e[t+1]);for(let t=0;t<i.length;t++)if(this.lineIntersectsLine(n,i[t]))return!0}if(s){var r=new D(e[e.length-1],e[0]);for(let t=0;t<i.length;t++)if(this.lineIntersectsLine(r,i[t]))return!0}return!1}scorePath(e){if(e.length<=2)return-1;let s=0;for(let t=1;t<e.length-1;t++)if(e[t-1].x==e[t].x&&e[t].x==e[t+1].x){if(this.signum(e[t+1].y-e[t].y)!=this.signum(e[t].y-e[t-1].y))return-1;s++}else if(e[t-1].y==e[t].y&&e[t].y==e[t+1].y){if(this.signum(e[t+1].x-e[t].x)!=this.signum(e[t].x-e[t-1].x))return-1;s++}else s--;return s}signum(t){return 0<t?1:t<0?-1:0}forwardPath(e){if(e.length<=2)return!0;for(let t=0;t<e.length-2;t++)if(e[t].x==e[t+1].x&&e[t+1].x==e[t+2].x){if(0!=this.signum(e[t+1].y-e[t].y)&&this.signum(e[t+1].y-e[t].y)==-1*this.signum(e[t+2].y-e[t+1].y))return!1}else if(e[t].y==e[t+1].y&&e[t+1].y==e[t+2].y&&0!=this.signum(e[t+1].x-e[t].x)&&this.signum(e[t+1].x-e[t].x)==-1*this.signum(e[t+2].x-e[t+1].x))return!1;return!0}distance(t,e){return Math.hypot(e.x-t.x,e.y-t.y)}max(t){if(0==t.lenght)return NaN;for(var e=t[0],s=0;s<t.length;s++)e<t[s]&&(e=t[s]);return e}min(t){if(0==t.lenght)return NaN;for(var e=t[0],s=0;s<t.length;s++)e>t[s]&&(e=t[s]);return e}addDot(t,e){throw new Error("Can NOT add dot to ICEVisioLink mannually.")}rmDot(t){throw new Error("Can NOT remove dot from ICEVisioLink mannually.")}}class Is extends $e{constructor(){let t={radius:10,edges:3,...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}};t.width=2*t.radius,t.height=2*t.radius,super(t),n(this,"radius",10),n(this,"edges",3),this.radius=this.props.radius,this.edges=this.props.edges}calcDots(){this.state.dots=[];var e=2*Math.PI/this.state.edges;for(let t=0;t<this.state.edges;t++){var s=e*t,i=this.state.radius,n=Math.floor(i*Math.cos(s)+i),s=Math.floor(i*Math.sin(s)+i);this.state.dots.push([n,s])}return this.state.dots}}class ks extends M{constructor(){super({text:"",left:0,top:0,fontSize:48,fontFamily:"Arial",fontWeight:24,...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}})}initEvents(){}calcOriginalDimension(){const t=this.root.document.createElement("div");t.contenteditable=!1,t.innerHTML=this.state.text,t.style.position="absolute",t.style.top="200px",t.style.left="0",t.style.fontFamily=this.state.fontFamily,t.style.fontWeight=this.state.fontWeight,t.style.fontSize=this.state.fontSize+"px",this.root.document.body.appendChild(t);var e={width:t.offsetWidth,height:t.offsetHeight};return this.root.document.body.removeChild(t),this.props.width=e.width,this.props.height=e.height,this.state.width=e.width,this.state.height=e.height,{width:this.state.width,height:this.state.height}}doRender(){this.ctx.strokeText(this.state.text,0-this.state.localOrigin[0],0-this.state.localOrigin[1]+this.state.height,this.state.width),this.ctx.fillText(this.state.text,0-this.state.localOrigin[0],0-this.state.localOrigin[1]+this.state.height,this.state.width)}}const Hs=Object.fromEntries(new Map([["ICERect",ts],["ICECircle",Os],["ICEEllipse",xs],["ICEStar",class extends Is{constructor(){super({radius:10,edges:5,...0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}})}doCreatePath(){this.path2D=new Path2D;let t=0,e=0;for(;t<this.state.edges;){var s=(e+2)%this.state.edges,i=this.state.dots[e],n=this.state.dots[s];0==t&&this.path2D.moveTo(i[0],i[1]),this.path2D.lineTo(n[0],n[1]),e=s,t++}return this.path2D.closePath(),this.path2D}}],["ICEIsogon",Is],["ICEText",ks],["ICEImage",Ds],["ICEGroup",os],["ICEVisioLink",Fs],["ICEPolyLine",ws]]));class js{constructor(t){n(this,"ice",void 0),this.ice=t}fromJSON(t){var t=JSON.parse(t),e=(console.log(t),t.childNodes);for(let t=0;t<e.length;t++)this.decodeRecursively(this.ice,e[t])}decodeRecursively(t,e){const s=Hs[e.type];var i=e.state,n=new s(i),r=(t.addChild(n),e.childNodes);if(r&&r.length)for(let t=0;t<r.length;t++)this.decodeRecursively(n,r[t])}}class zs{constructor(t){n(this,"ice",void 0),this.ice=t}toJSON(){let e={createTime:(new Date).toLocaleString(),lastModifyTime:(new Date).toLocaleString(),childNodes:[]};return this.ice.childNodes.forEach(t=>{t instanceof A||t.parentNode instanceof A||t instanceof T||t instanceof Ss?console.warn("控制手柄类型的组件不需要存储...",t):this.encodeRecursively(t,e)}),console.log(e),JSON.stringify(e)}encodeRecursively(e,t){var s={state:e.state,type:e.constructor.name,childNodes:[]};if(t.childNodes.push(s),e.childNodes&&e.childNodes.length)for(let t=0;t<e.childNodes.length;t++)this.encodeRecursively(e.childNodes[t],s)}}class Us extends C{constructor(t){super(),n(this,"ice",void 0),n(this,"stopped",!1),n(this,"renderQueue",[]),this.ice=t}start(){return this.stopped=!1,this.ice.evtBus.on(w.ICE_FRAME_EVENT,this.frameEvtHandler,this),this}stop(){return this.stopped=!0,this.ice.evtBus.off(w.ICE_FRAME_EVENT,this.frameEvtHandler,this),this}frameEvtHandler(t){this.needUpdate()?this.doRender():console.log("没有需要渲染的组件...")}needUpdate(){return!(!this.ice.childNodes||!this.ice.childNodes.length)&&this.ice._dirty}doRender(){var t=Date.now(),e=(this.ice.ctx.clearRect(0,0,this.ice.canvasWidth,this.ice.canvasHeight),this.renderQueue=Array.from(this.ice.childNodes),console.log("Render Queue length> "+this.renderQueue.length),this.renderQueue.sort((t,e)=>t.state.zIndex-e.state.zIndex),this.renderQueue.forEach(t=>{this.renderRecursively(t)}),this.ice._dirty=!1,this.ice.evtBus.trigger(w.ROUND_FINISH),Date.now());console.log(` Render time ${e-t} ms.`)}renderRecursively(e){this.trigger(w.BEFORE_RENDER,null,{component:e}),e.trigger(w.BEFORE_RENDER),e.state.display&&(e.render(),e.childNodes&&e.childNodes.length&&e.childNodes.forEach(t=>{t.root=e.root,t.ctx=e.ctx,t.evtBus=e.evtBus,t.ice=e.ice,t.parentNode=e,this.renderRecursively(t)}),e.trigger(w.AFTER_RENDER),this.trigger(w.AFTER_RENDER,null,{component:e}))}}n(Us,"MAX_QUE_LENGTH",5e6),n(Us,"FRAME_TIME",16);let Ls=(new class{constructor(){n(this,"childNodes",[]),n(this,"evtBus",void 0),n(this,"root",void 0),n(this,"canvasEl",void 0),n(this,"ctx",void 0),n(this,"canvasWidth",0),n(this,"canvasHeight",0),n(this,"canvasBoundingClientRect",void 0),n(this,"selectionList",[]),n(this,"renderer",void 0),n(this,"animationManager",void 0),n(this,"eventBridge",void 0),n(this,"ddManager",void 0),n(this,"controlPanelManager",void 0),n(this,"linkSlotManager",void 0),n(this,"serializer",void 0),n(this,"deserializer",void 0),n(this,"_dirty",!0)}init(t){if(!t)throw new Error("ICE.init() failed...");if(this.ctx===t)throw new Error("同一个 canvas 实例只能 init 一次...");return this.root=S,es(t)?(this.canvasEl=this.root.document.getElementById(t),this.canvasEl.oncontextmenu=function(t){t.preventDefault(),t.stopPropagation()},this.canvasWidth=this.canvasEl.width,this.canvasHeight=this.canvasEl.height,this.canvasBoundingClientRect=this.canvasEl.getBoundingClientRect(),this.ctx=this.canvasEl.getContext("2d")):this.ctx=t,this.evtBus=new Ts,B.regitserEvtBus(this.evtBus),B.start(),_.regitserEvtBus(this.evtBus),_.start(),this.eventBridge=new Bs(this).start(),this.animationManager=new ns(this).start(),this.ddManager=new rs(this).start(),this.controlPanelManager=new Ps(this).start(),this.renderer=new Us(this).start(),this.linkSlotManager=new Ns(this).start(),this.serializer=new zs(this),this.deserializer=new js(this),this}addChild(t){-1===this.childNodes.indexOf(t)&&(t.trigger(w.BEFORE_ADD),t.ice=this,t.root=this.root,t.ctx=this.ctx,t.evtBus=this.evtBus,t.renderer=this.renderer,this.childNodes.push(t),Object.keys(t.props.animations).length&&this.animationManager.add(t),t.trigger(w.AFTER_ADD))}addChildren(t){t.forEach(t=>{this.addChild(t)})}removeChild(t){t instanceof A||t.parentNode instanceof A||t instanceof Ss?console.warn("控制手柄类型的组件不能删除...",t):(t.destory(),this.childNodes.splice(this.childNodes.indexOf(t),1))}removeChildren(t){t.forEach(t=>{this.removeChild(t)})}clearAll(){this.removeChildren([...this.childNodes])}findComponent(e){return this.childNodes.filter(t=>t.props.id===e)[0]}toJSON(){return this.serializer.toJSON()}fromJSON(t){var e=(new Date).getTime(),t=(B.stop(),this.renderer.stop(),this.eventBridge.stopped=!0,this.animationManager.stop(),this.ddManager.stop(),this.controlPanelManager.stop(),this.linkSlotManager.stop(),this.clearAll(),this.deserializer.fromJSON(t),console.log("deserialize>",this.childNodes),B.start(),this.renderer.start(),this.animationManager.start(),this.ddManager.start(),this.controlPanelManager.start(),this.linkSlotManager.start(),setTimeout(()=>{this.eventBridge.stopped=!1},300),(new Date).getTime());console.log(`fromJSON> ${t-e} ms`)}}).init("canvas-1"),Vs=(document.querySelector("#btn-1").addEventListener("click",t=>{var e=Ls.toJSON();window.localStorage.setItem("json-data",e)}),document.querySelector("#btn-2").addEventListener("click",t=>{var e=window.localStorage.getItem("json-data");Ls.fromJSON(e)}),document.querySelector("#btn-3").addEventListener("click",t=>{Ls.clearAll()}),new ts({left:100,top:100,width:300,height:200,style:{strokeStyle:"#0c09d4",fillStyle:"#f5d106",lineWidth:5},transform:{skew:[10,0]}}));Vs.on("click",t=>{console.log("baseRect1")}),Ls.addChild(Vs)});
